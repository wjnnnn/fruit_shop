<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>确认订单</title>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script type="text/javascript">
    (function() {
      // ★★★ 请在这里填入你的 Public Key ★★★
      emailjs.init("ExSs316GOXr9b87a-");
    })();
  </script>

  <style>
    body { font-family: 'PingFang SC', sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; padding: 20px; }

    /* 商品卡片样式 */
    .order-card { background: #fff8e1; border: 1px solid #ffe0b2; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .price-tag { color: #ff5722; font-weight: bold; font-size: 1.2em; }

    /* 输入框样式 */
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
    input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1em; }

    /* 支付按钮 */
    .btn-submit { background: #ff5722; color: white; border: none; padding: 15px; width: 100%; border-radius: 30px; font-size: 1.1em; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(255,87,34,0.3); }
    .btn-submit:hover { background: #e64a19; }

    /* 优惠券提示 */
    .coupon-tip { font-size: 0.9em; color: #4CAF50; display: none; margin-top: 5px; }

    /* --- 弹窗样式 --- */
    .pay-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; justify-content: center; align-items: center; }
    .pay-content { background: white; padding: 25px; border-radius: 15px; text-align: center; width: 85%; max-width: 350px; animation: pop 0.3s; }
    .pay-code-img { width: 220px; height: 220px; margin: 15px 0; border: 1px solid #eee; border-radius: 8px; }

    /* 弹窗按钮组 */
    .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
    .btn-confirm { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; flex: 1; }
    .btn-cancel { background: #9e9e9e; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; flex: 1; }

    @keyframes pop { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }
  </style>
</head>
<body>

<div class="container">
  <h2>填写收货信息</h2>

  <!-- 商品信息卡片 -->
  <div class="order-card">
    <h3 id="itemName" style="margin-top:0">加载中...</h3>

    <div class="row">
      <label>单价：</label>
      <span id="unitPrice">￥0.00/kg</span>
    </div>

    <div class="form-group">
      <label>购买重量 (kg)：</label>
      <!-- 这里是可以修改数字的地方 -->
      <input type="number" id="weightInput" value="1" min="0.5" step="0.5" onchange="calculateTotal()" oninput="calculateTotal()">
    </div>

    <div style="border-top: 1px dashed #ccc; margin: 10px 0;"></div>

    <div class="row">
      <label>优惠券抵扣：</label>
      <span id="couponDisplay">-￥0.00</span>
    </div>

    <div class="row" style="margin-bottom: 0;">
      <label style="font-size: 1.1em;">实付金额：</label>
      <span id="finalPrice" class="price-tag">￥0.00</span>
    </div>
  </div>

  <!-- 收货表单 -->
  <form onsubmit="showPayModal(event)">
    <div class="form-group">
      <label>收货人姓名</label>
      <input type="text" id="c_name" placeholder="请输入姓名" required>
    </div>
    <div class="form-group">
      <label>手机号码</label>
      <input type="tel" id="c_phone" placeholder="请输入手机号" required>
    </div>
    <div class="form-group">
      <label>详细地址</label>
      <textarea id="c_address" rows="3" placeholder="省/市/区/街道门牌号" required></textarea>
    </div>
    <button type="submit" class="btn-submit">立即支付</button>
  </form>
</div>

<!-- 支付弹窗 -->
<div id="payModal" class="pay-modal">
  <div class="pay-content">
    <h3>请扫码支付</h3>
    <p>支付金额：<span id="payAmountDisp" style="color:#ff5722; font-weight:bold; font-size:1.2em"></span></p>

    <!-- 你的收款码图片 -->
    <img src="pay_code.jpg" alt="微信支付" class="pay-code-img">

    <div class="btn-group">
      <!-- 取消按钮 -->
      <button class="btn-cancel" onclick="closePayModal()">暂不支付</button>
      <!-- 确认按钮 -->
      <button class="btn-confirm" onclick="confirmPayment()" id="btnSend">我已支付</button>
    </div>
  </div>
</div>

<script>
  // 水果数据库 (单价表)
  const fruitDB = [
    { id: 0, name: "红富士苹果", price: 10.5 },
    { id: 1, name: "进口香蕉", price: 5.0 },
    { id: 2, name: "巨峰葡萄", price: 8.5 },
    { id: 3, name: "赣南脐橙", price: 6.0 },
    { id: 4, name: "皇冠梨", price: 12.0 }
  ];

  // 全局变量
  let currentUnitPrice = 0;
  let currentCoupon = 0;

  // 1. 页面加载时执行
  window.onload = function() {
    // 获取 URL 里的 id 参数 (例如 ?id=1)
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const fruit = fruitDB[parseInt(id)];

    if(fruit) {
      document.getElementById('itemName').innerText = fruit.name;
      document.getElementById('unitPrice').innerText = `￥${fruit.price.toFixed(2)}/kg`;
      currentUnitPrice = fruit.price;
    }

    // 获取本地存储的优惠券
    const savedCoupon = localStorage.getItem('my_coupon');
    if(savedCoupon) {
      currentCoupon = parseFloat(savedCoupon);
      document.getElementById('couponDisplay').innerText = `-￥${currentCoupon.toFixed(2)}`;
      document.getElementById('couponDisplay').style.color = "#4CAF50";
    }

    // 初始计算一次总价
    calculateTotal();
  };

  // 2. 核心：计算总价函数
  function calculateTotal() {
    // 获取用户输入的重量
    let weight = parseFloat(document.getElementById('weightInput').value);
    if(isNaN(weight) || weight < 0) weight = 0;

    // 计算公式：(单价 * 重量) - 优惠券
    let total = (currentUnitPrice * weight) - currentCoupon;

    // 防止金额小于0
    if(total < 0) total = 0;

    // 更新界面显示
    document.getElementById('finalPrice').innerText = `￥${total.toFixed(2)}`;
  }

  // 3. 显示支付弹窗
  function showPayModal(e) {
    e.preventDefault(); // 阻止表单跳转

    // 获取最终金额
    const finalAmt = document.getElementById('finalPrice').innerText;
    document.getElementById('payAmountDisp').innerText = finalAmt;

    // 显示弹窗
    document.getElementById('payModal').style.display = 'flex';
  }

  // 4. 关闭支付弹窗 (取消功能)
  function closePayModal() {
    document.getElementById('payModal').style.display = 'none';
  }

  // 5. 确认支付并发送通知
  function confirmPayment() {
    const btn = document.getElementById('btnSend');
    btn.innerText = "通知中...";
    btn.disabled = true;

    const weight = document.getElementById('weightInput').value;
    const itemName = document.getElementById('itemName').innerText;
    const price = document.getElementById('finalPrice').innerText;

    const templateParams = {
      item_name: itemName,
      weight: weight,
      price: price,
      customer_name: document.getElementById('c_name').value,
      customer_phone: document.getElementById('c_phone').value,
      customer_address: document.getElementById('c_address').value
    };

    // ★★★ 这里填你的 EmailJS ServiceID 和 TemplateID ★★★
    emailjs.send('service_fk2ry8w', 'template_9hh4g4u', templateParams)
      .then(function() {
        alert('支付成功！商家已收到订单，将尽快为您发货。');
        localStorage.removeItem('my_coupon'); // 用完优惠券清除
        window.location.href = "index.html"; // 回首页
      }, function(error) {
        alert('通知失败: ' + JSON.stringify(error));
        btn.disabled = false;
        btn.innerText = "重试";
      });
  }
</script>
</body>
</html>
